@startuml
skinparam lifelineStrategy solid
skinparam responseMessageBelowArrow true

actor Attendant
participant "PaymentGateway" as PG <<external>>

boundary ExitUI
boundary GateDevice
control CheckOutController
control MembershipController
control PaymentController
entity ParkingSession
entity PricePolicy
entity Payment

'==================== CHECK-OUT ====================
Attendant -> ExitUI : Quẹt vé
ExitUI -> GateDevice : readCardOrPlate()
GateDevice --> ExitUI : cardOrPlateId

ExitUI -> CheckOutController : requestCheckOut(cardOrPlateId, gateId)

'--- ưu tiên kiểm tra vé tháng trước (quẹt là ra)
CheckOutController -> MembershipController : verifyMembershipByCardOrPlate(cardOrPlateId)
MembershipController --> CheckOutController : membershipInfo(hasMonthlyTicket true/false)

alt CÓ VÉ THÁNG (hợp lệ)
  CheckOutController --> ExitUI : showMessage("Vé tháng hợp lệ - mời xe ra")
  CheckOutController -> GateDevice : openGate(gateId)
  GateDevice --> ExitUI : opened
else KHÔNG CÓ VÉ THÁNG
  '--- lúc này mới xử lý vé lượt hoặc mất vé
  CheckOutController -> ParkingSession : findOpenSession(cardOrPlateId)
  ParkingSession --> CheckOutController : session / null

  alt CÓ VÉ LƯỢT (tìm thấy session)
    CheckOutController -> ParkingSession : setExitTime(now)

    CheckOutController -> PricePolicy : calculateFee(session)
    PricePolicy --> CheckOutController : feeAmount

    CheckOutController -> CheckOutController : sessionToPay = session

  else MẤT VÉ (không tìm thấy session)
    CheckOutController -> ExitUI : printLostTicketForm()
    Attendant -> ExitUI : xác thực tính hợp lệ của giấy tờ xe 

    alt Giấy tờ KHÔNG hợp lệ
      CheckOutController --> ExitUI : showError("Thông tin xe/giấy tờ không hợp lệ,\nkhông cho xuất bãi")
    else Giấy tờ hợp lệ
      CheckOutController -> PricePolicy : calculateLostTicketFee(vehicleInfo)
      PricePolicy --> CheckOutController : lostTicketFee

      CheckOutController -> PricePolicy : calculateParkingFeeForLostTicket(vehicleInfo, now)
      PricePolicy --> CheckOutController : parkingFee

      CheckOutController -> CheckOutController : feeAmount = lostTicketFee + parkingFee

      CheckOutController -> ParkingSession : createLostTicketSession(vehicleInfo, feeAmount)
      ParkingSession --> CheckOutController : lostSession

      CheckOutController -> CheckOutController : sessionToPay = lostSession
    end
  end

  '==================== THANH TOÁN CHUNG ====================
  CheckOutController -> ExitUI : showFeeInfo(feeAmount)

   ExitUI -> PaymentController : processPayment(sessionToPay, feeAmount, paymentInfo)

  PaymentController -> PG : requestPayment(feeAmount, paymentInfo)
  PG --> PaymentController : paymentResult(success/fail)

  alt Thanh toán thành công
    PaymentController -> Payments: createPayment(amount)
  Payments --> PaymentController: markedCompleted()
  PaymentController --> MembershipController: paymentCompleted

    PaymentController --> ExitUI : showMessage("Thanh toán OK, mời xe ra")
    CheckOutController -> GateDevice : openGate(gateId)
    GateDevice --> ExitUI : opened
  else Thanh toán thất bại
    PaymentController --> ExitUI : showError("Thanh toán thất bại,\nvui lòng thử lại")
    return
  end
end

@enduml
