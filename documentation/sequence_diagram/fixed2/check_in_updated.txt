@startuml
skinparam lifelineStrategy solid

actor Attendant

boundary EntryUI
boundary GateDevice
control CheckInController
control ParkingService
database MonthlyTicketRepo
database ZoneRepo
database SessionRepo
database TicketRepo

'===== BẮT ĐẦU CHECK-IN (FIXED) =====
Attendant -> EntryUI : nhập biển số xe + loại xe (Car/Moto...)
note right of Attendant
  Không cần chọn Zone thủ công.
  Hệ thống tự động điều phối.
end note

EntryUI -> CheckInController : CheckIn(plate, type, gateId)

CheckInController -> ParkingService : CheckInAsync(plate, type, gateId)

' 1. Kiểm tra xe đang trong bến?
ParkingService -> SessionRepo : FindActiveByPlate(plate)
SessionRepo --> ParkingService : existingSession (null)

' 2. Kiểm tra vé tháng (Discrepancy 2 Fixed: Service Layer)
ParkingService -> MonthlyTicketRepo : FindActiveByPlate(plate)
MonthlyTicketRepo --> ParkingService : monthlyTicket

alt Có vé tháng (monthlyTicket != null)
    ParkingService -> ParkingService : use monthly ticket info

else Không có vé tháng (Khách vãng lai)
    ParkingService -> TicketRepo : CreateNewTicket(gateId)
end

' 3. Tự động chọn Zone (Discrepancy 3 Fixed: Auto-allocation)
ParkingService -> ZoneRepo : FindSuitableZone(type, isElectric)
ZoneRepo --> ParkingService : zone

alt Zone found & Available
    ' Tạo session
    ParkingService -> SessionRepo : Add(session)
    SessionRepo --> ParkingService : success
    
    ' Mở cổng
    ParkingService -> GateDevice : OpenGate(gateId)
    GateDevice --> ParkingService : opened
    
    ParkingService --> CheckInController : sessionInfo
    CheckInController -> EntryUI : ShowSuccess(ticketInfo)
    EntryUI -> Attendant : "Mời xe vào"
else Zone Full / Not Found
    ParkingService --> CheckInController : Error("Bãi đầy/Không tìm thấy khu vực")
    CheckInController -> EntryUI : ShowError
end

@enduml
