@startuml
skinparam lifelineStrategy solid
skinparam responseMessageBelowArrow true

actor Attendant
participant "PaymentGateway" as PG <<external>>

boundary ExitUI
boundary GateDevice
control CheckOutController
control PaymentController
control ParkingService
control PaymentService
database SessionRepo
database PricePolicyRepo
entity PricePolicy

'==================== CHECK-OUT (REFACTORED) ====================
Attendant -> ExitUI : Quẹt vé hoặc Nhập biển số
ExitUI -> CheckOutController : RequestCheckOut(ticketOrPlate)

CheckOutController -> ParkingService : CheckOutAsync(ticketOrPlate)

' 1. Logic nghiệp vụ trong ParkingService
ParkingService -> SessionRepo : FindByTicketOrPlate(ticketOrPlate)
SessionRepo --> ParkingService : session

alt Session Found
    ' 2. Tính tiền & Xử lý (Encapsulation: Service tự quyết định)
    alt Vé tháng (isMonthly = true)
        ParkingService -> ParkingService : fee = 0, status = Completed
        ParkingService -> SessionRepo : Update(session)
        
        ' Case A: Service tự mở cổng cho vé tháng (Black Box)
        ParkingService -> GateDevice : OpenGate(gateId)
        GateDevice --> ParkingService : opened
        
    else Vé lượt
        ParkingService -> PricePolicyRepo : GetPolicy(vehicleType)
        PricePolicyRepo --> ParkingService : policy
        ParkingService -> PricePolicy : CalculateFee(session)
        PricePolicy --> ParkingService : feeAmount
        ParkingService -> SessionRepo : Update(session)
    end
    
    ParkingService --> CheckOutController : sessionInfo (fee, status)
    CheckOutController -> ExitUI : ShowInfo(fee, session)
    
    '==================== THANH TOÁN ====================
    alt Fee > 0 (Khách vãng lai)
        Attendant -> ExitUI : Xác nhận thanh toán (QR)
        ExitUI -> PaymentController : Pay(sessionId, amount)
        
        ' Case B: PaymentService chỉ làm tiền, không làm cổng (SRP)
        PaymentController -> PaymentService : ProcessPayment(sessionId, amount)
        PaymentService -> PG : CreateTransaction()
        PG --> PaymentService : QrData
        PaymentService --> PaymentController : Result(QrContent)
        PaymentController --> ExitUI : ShowQR(QrData)
        
        ' ... Async Callback Flow ...
        PG -> PaymentController : Callback(Success)
        
        ' Case B: PaymentController nhờ ParkingService mở cổng
        PaymentController -> ParkingService : ConfirmPaymentAsync(sessionId, Success)
        
        ParkingService -> SessionRepo : UpdateStatus("Completed")
        ParkingService -> GateDevice : OpenGate()
        GateDevice --> ParkingService : Opened
        
        ParkingService --> PaymentController : PaymentResult
        PaymentController --> PG : 200 OK
        
    else Fee = 0 (Vé tháng)
        ' Đã mở cổng ở trên
        CheckOutController -> ExitUI : "Vé tháng hợp lệ. Mời ra."
    end

else Session Not Found
    ParkingService --> CheckOutController : Error(NotFound)
    CheckOutController -> ExitUI : "Không tìm thấy xe / Mất vé?"
end

@enduml
