@startuml
actor "User/Staff" as User
participant "MembershipController" as Ctrl
participant "MembershipService" as Svc
participant "MonthlyTicketRepo" as TicketRepo
participant "CustomerRepo" as CustRepo
participant "PaymentGateway" as Payment

User -> Ctrl: POST /register(plate, customerInfo)
activate Ctrl

Ctrl -> Svc: RegisterMonthlyTicketAsync(dto)
activate Svc

    ' 1. Logic Check
    Svc -> TicketRepo: FindActiveByPlate(plate)
    alt Ticket Exists
        Svc --> Ctrl: Throw Exception (Vehicle already has active ticket)
    end

    ' 2. Customer Handling
    Svc -> CustRepo: FindByPhone(phone)
    opt New Customer
        Svc -> CustRepo: Add(newCustomer)
    end

    ' 3. Create Pending Ticket (State: PendingPayment)
    Svc -> Svc: CalculateFee()
    Svc -> TicketRepo: Add(new Ticket(Status='PendingPayment', PaymentStatus='PendingExternal'))
    activate TicketRepo
    TicketRepo --> Svc: return ticketId
    deactivate TicketRepo

    ' 4. Request Payment
    Svc -> Payment: RequestPayment(ticketId, amount)
    activate Payment
    Payment --> Svc: return paymentUrl/QR
    deactivate Payment

    ' 5. Update Ticket with Payment Info
    Svc -> TicketRepo: Update(ticket with QrContent/TransactionCode)

Svc --> Ctrl: return (PendingTicket, PaymentUrl)
deactivate Svc

Ctrl --> User: Show Payment QR & Ticket Info
deactivate Ctrl

note right of User
  User scans QR and pays.
  Payment Gateway calls Webhook
  OR User calls Confirm API
end note

' 6. Payment Confirmation / Callback
group Payment Confirmation
    Payment -> Ctrl: POST /payment-callback (or User -> Confirm)
    activate Ctrl
    
    Ctrl -> TicketRepo: GetById(ticketId)
    activate TicketRepo
    TicketRepo --> Ctrl: ticket
    deactivate TicketRepo

    alt Payment Success
        Ctrl -> Ctrl: ticket.Activate()
        note right: Status -> Active\nPaymentStatus -> Completed\nStartDate -> Now
    else Payment Failed
        Ctrl -> Ctrl: ticket.SetPaymentFailed()
    end

    Ctrl -> TicketRepo: Update(ticket)
    Ctrl --> Payment: return OK
    deactivate Ctrl
end

@enduml
