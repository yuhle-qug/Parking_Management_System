@startuml
skinparam lifelineStrategy solid
skinparam responseMessageBelowArrow true

actor Attendant
participant "PaymentGateway" as PG <<external>>

boundary ExitUI
boundary GateDevice
control CheckOutController
control PaymentController
control ParkingService
database SessionRepo
database PricePolicyRepo
entity PricePolicy

'==================== CHECK-OUT (FIXED) ====================
Attendant -> ExitUI : Quẹt vé hoặc Nhập biển số
ExitUI -> CheckOutController : RequestCheckOut(ticketOrPlate)

CheckOutController -> ParkingService : CheckOutAsync(ticketOrPlate)

' 1. Tìm thông tin gửi xe
ParkingService -> SessionRepo : FindByTicketOrPlate(ticketOrPlate)
SessionRepo --> ParkingService : session

alt Session Found
    ' 2. Tính tiền (Service logic)
    alt Vé tháng (isMonthly = true)
        ParkingService -> ParkingService : fee = 0
    else Vé lượt
        ParkingService -> PricePolicyRepo : GetPolicy(vehicleType)
        PricePolicyRepo --> ParkingService : policy
        ParkingService -> PricePolicy : CalculateFee(session)
        PricePolicy --> ParkingService : feeAmount
    end
    
    ParkingService --> CheckOutController : sessionInfo (fee, status)
    CheckOutController -> ExitUI : ShowInfo(fee, session)
    
    '==================== THANH TOÁN ====================
    alt Fee > 0 (Khách vãng lai)
        Attendant -> ExitUI : Xác nhận thanh toán (QR)
        ExitUI -> PaymentController : Pay(sessionId, amount, method="QR")
        
        PaymentController -> PG : CreateTransaction()
        PG --> PaymentController : QrData
        PaymentController --> ExitUI : ShowQR(QrData)
        
        ' ... Async Callback Flow ...
        PG -> PaymentController : Callback(Success)
        PaymentController -> ParkingService : ConfirmPayment(sessionId)
        ParkingService -> SessionRepo : UpdateStatus("Completed")
        ParkingService -> GateDevice : OpenGate()
        ParkingService --> PaymentController : Success
        PaymentController --> ExitUI : "Thanh toán thành công, Cổng mở"
        
    else Fee = 0 (Vé tháng)
        ' Tự động mở cổng (Discrepancy 2 Fixed)
        CheckOutController -> ParkingService : ProcessFreeExit(sessionId)
        ParkingService -> GateDevice : OpenGate()
        GateDevice --> CheckOutController : Opened
        CheckOutController -> ExitUI : "Vé tháng hợp lệ. Mời ra."
    end

else Session Not Found
    ParkingService --> CheckOutController : Error(NotFound)
    CheckOutController -> ExitUI : "Không tìm thấy xe / Mất vé?"
    ' (Flow xử lý mất vé tách riêng qua endpoint lost-ticket)
end

@enduml
